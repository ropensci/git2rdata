<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Efficiency Relative to Storage and Time • git2rdata</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Efficiency Relative to Storage and Time">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">git2rdata</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/plain_text.html">Getting started storing dataframes as plain text</a></li>
    <li><a class="dropdown-item" href="../articles/version_control.html">Storing dataframes under version control</a></li>
    <li><a class="dropdown-item" href="../articles/metadata.html">Metadata</a></li>
    <li><a class="dropdown-item" href="../articles/workflow.html">Potential workflow</a></li>
    <li><a class="dropdown-item" href="../articles/efficiency.html">Efficiency</a></li>
    <li><a class="dropdown-item" href="../articles/split_by.html">Large dataframes</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../CONTRIBUTING.html">Contributing</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ropensci/git2rdata/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Efficiency Relative to Storage and Time</h1>
                        <h4 data-toc-skip class="author">Thierry
Onkelinx</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/git2rdata/blob/main/vignettes/efficiency.Rmd" class="external-link"><code>vignettes/efficiency.Rmd</code></a></small>
      <div class="d-none name"><code>efficiency.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette compares storage and retrieval of data by
<code>git2rdata</code> with other standard R functionality. We consider
<code><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table()</a></code> and <code><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table()</a></code> for data stored
in a plain text format. <code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS()</a></code> and
<code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS()</a></code> use a compressed binary format.</p>
<p>To get some meaningful results, we will use the <code>nassCDS</code>
dataset from the <a href="https://www.rdocumentation.org/packages/DAAG/versions/1.22/topics/nassCDS" class="external-link">DAAG</a>
package. <!-- spell-check: ignore --> We’ll avoid the dependency on the
package by directly downloading the data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">airbag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://vincentarelbundock.github.io/Rdatasets/csv/DAAG/nassCDS.csv"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">airbag</span><span class="op">$</span><span class="va">dead</span> <span class="op">&lt;-</span> <span class="va">airbag</span><span class="op">$</span><span class="va">dead</span> <span class="op">==</span> <span class="st">"dead"</span></span>
<span><span class="va">airbag</span><span class="op">$</span><span class="va">airbag</span> <span class="op">&lt;-</span> <span class="va">airbag</span><span class="op">$</span><span class="va">airbag</span> <span class="op">==</span> <span class="st">"airbag"</span></span>
<span><span class="va">airbag</span><span class="op">$</span><span class="va">seatbelt</span> <span class="op">&lt;-</span> <span class="va">airbag</span><span class="op">$</span><span class="va">seatbelt</span> <span class="op">==</span> <span class="st">"belted"</span></span>
<span><span class="va">airbag</span><span class="op">$</span><span class="va">dvcat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.ordered</a></span><span class="op">(</span><span class="va">airbag</span><span class="op">$</span><span class="va">dvcat</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">airbag</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    26217 obs. of  16 variables:</span></span>
<span><span class="co">#&gt;  $ X          : int  1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span><span class="co">#&gt;  $ dvcat      : Ord.factor w/ 5 levels "1-9km/h"&lt;"10-24"&lt;..: 3 2 2 3 3 4 5 5 2 2 ...</span></span>
<span><span class="co">#&gt;  $ weight     : num  25.1 25.1 32.4 495.4 25.1 ...</span></span>
<span><span class="co">#&gt;  $ dead       : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...</span></span>
<span><span class="co">#&gt;  $ airbag     : logi  FALSE TRUE FALSE TRUE FALSE FALSE ...</span></span>
<span><span class="co">#&gt;  $ seatbelt   : logi  TRUE TRUE FALSE TRUE TRUE TRUE ...</span></span>
<span><span class="co">#&gt;  $ frontal    : int  1 1 1 1 1 1 1 1 0 1 ...</span></span>
<span><span class="co">#&gt;  $ sex        : Factor w/ 2 levels "f","m": 1 1 1 1 1 1 2 2 2 1 ...</span></span>
<span><span class="co">#&gt;  $ ageOFocc   : int  26 72 69 53 32 22 22 32 40 18 ...</span></span>
<span><span class="co">#&gt;  $ yearacc    : int  1997 1997 1997 1997 1997 1997 1997 1997 1997 1997 ...</span></span>
<span><span class="co">#&gt;  $ yearVeh    : int  1990 1995 1988 1995 1988 1985 1984 1987 1984 1987 ...</span></span>
<span><span class="co">#&gt;  $ abcat      : Factor w/ 3 levels "deploy","nodeploy",..: 3 1 3 1 3 3 3 3 3 3 ...</span></span>
<span><span class="co">#&gt;  $ occRole    : Factor w/ 2 levels "driver","pass": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ deploy     : int  0 1 0 1 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ injSeverity: int  3 1 4 1 3 3 3 4 1 0 ...</span></span>
<span><span class="co">#&gt;  $ caseid     : Factor w/ 9409 levels "11:1:1","11:1:2",..: 1645 1646 1688 1488 1510 1511 1555 1556 1571 1572 ...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-storage">Data Storage<a class="anchor" aria-label="anchor" href="#data-storage"></a>
</h2>
<div class="section level3">
<h3 id="on-a-file-system">On a File System<a class="anchor" aria-label="anchor" href="#on-a-file-system"></a>
</h3>
<p>We start by writing the dataset as is with
<code><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table()</a></code>, <code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS()</a></code>,
<code><a href="../reference/write_vc.html">write_vc()</a></code> and <code><a href="../reference/write_vc.html">write_vc()</a></code> without storage
optimization. Note that <code><a href="../reference/write_vc.html">write_vc()</a></code> uses optimization by
default. Since <code><a href="../reference/write_vc.html">write_vc()</a></code> creates two files for each data
set, we take their combined file size into account.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ropensci.github.io/git2rdata/">git2rdata</a></span><span class="op">)</span></span>
<span><span class="va">root</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"git2rdata-efficient"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">root</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"base_R.tsv"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\t"</span><span class="op">)</span></span>
<span><span class="va">base_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.size</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"base_R.tsv"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"base_R.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rds_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.size</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"base_R.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="st">"airbag_optimize"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in meta.data.frame(x, optimize = optimize, na = na, sorting = sorting,</span></span>
<span><span class="co">#&gt; : `digits` was not set. Setting is automatically to 6. See ?meta</span></span>
<span><span class="va">optim_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.size</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="va">fn</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="st">"airbag_verbose"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span>, optimize <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in meta.data.frame(x, optimize = optimize, na = na, sorting = sorting,</span></span>
<span><span class="co">#&gt; : `digits` was not set. Setting is automatically to 6. See ?meta</span></span>
<span><span class="va">verbose_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.size</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="va">fn</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Since the data is highly compressible, <code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS()</a></code> yields
the smallest file at the cost of having a binary file format. Both
<code><a href="../reference/write_vc.html">write_vc()</a></code> formats yield smaller files than
<code><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table()</a></code>. Partly because <code><a href="../reference/write_vc.html">write_vc()</a></code>
doesn’t store row names and doesn’t use quotes unless needed. The
difference between the optimized and verbose version of
<code><a href="../reference/write_vc.html">write_vc()</a></code> is, in this case, solely due to the way
<code><a href="../reference/write_vc.html">write_vc()</a></code> stores factors in the data (<code>tsv</code>)
file. The optimized version stores the indices of the factor whereas the
verbose version stores the levels. For example:
<code>airbag$dvcat</code> has 5 levels with short labels (on average 5
character), storing the index requires 1 character. This results in more
compact files.</p>
<table class="table">
<caption>Resulting file sizes (in kB) and file sizes relative to the
size of write.table().</caption>
<thead><tr class="header">
<th align="left">method</th>
<th align="right">file_size</th>
<th align="right">relative</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">saveRDS()</td>
<td align="right">313.13</td>
<td align="right">0.12</td>
</tr>
<tr class="even">
<td align="left">write_vc(), optimized</td>
<td align="right">1498.54</td>
<td align="right">0.55</td>
</tr>
<tr class="odd">
<td align="left">write_vc(), verbose</td>
<td align="right">2225.74</td>
<td align="right">0.82</td>
</tr>
<tr class="even">
<td align="left">write.table()</td>
<td align="right">2716.93</td>
<td align="right">1.00</td>
</tr>
</tbody>
</table>
<p>The reduction in file size when storing in factors depends on the
length of the labels, the number of levels and the number of
observations. The figure below illustrates the strong gain as soon as
the level labels contain more than two characters. The gain is less
pronounced when the factor has a large number of levels. The
optimization fails in extreme cases with short factor labels and a high
number of levels.</p>
<div class="figure">
<img src="efficiency_files/figure-html/factor_label_length-1.png" alt="Effect of the label length on the efficiency of storing factor optimized, assuming 1000 observations" width="576"><p class="caption">
Effect of the label length on the efficiency of storing factor
optimized, assuming 1000 observations
</p>
</div>
<p>The effect of the number of observations is mainly due to the
overhead of storing the metadata. The importance of this overhead
increases when the number of observations is small.</p>
<div class="figure">
<img src="efficiency_files/figure-html/factor_observations-1.png" alt="Effect of the number of observations on the efficiency of storing factor optimized assuming labels with 10 characters" width="576"><p class="caption">
Effect of the number of observations on the efficiency of storing factor
optimized assuming labels with 10 characters
</p>
</div>
</div>
<div class="section level3">
<h3 id="in-git-repositories">In Git Repositories<a class="anchor" aria-label="anchor" href="#in-git-repositories"></a>
</h3>
<p>Here we will simulate how much space the data requires to store the
history in a git repository. We will create a git repository for each
method and store different subsets of the same data. Each commit
contains a new version of the data. Each version is a random sample
containing 90% of the observations of the <code>airbag</code> data. Two
consecutive versions of the subset will have about 90% of the
observations in common.</p>
<p>After writing each version, we commit the file, perform garbage
collection (<code>git gc</code>) on the git repository and then
calculate the size of the git history
(<code>git count-objects -v</code>).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/git2r/" class="external-link">git2r</a></span><span class="op">)</span></span>
<span><span class="va">tmp_repo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">root</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"git2rdata-efficient-git"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">root</span><span class="op">)</span></span>
<span>  <span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu">git2r</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/git2r/reference/init.html" class="external-link">init</a></span><span class="op">(</span><span class="va">root</span><span class="op">)</span></span>
<span>  <span class="fu">git2r</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/git2r/reference/config.html" class="external-link">config</a></span><span class="op">(</span><span class="va">repo</span>, user.name <span class="op">=</span> <span class="st">"me"</span>, user.email <span class="op">=</span> <span class="st">"me@me.com"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">repo</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">commit_and_size</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">repo</span>, <span class="va">filename</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/git2r/reference/add.html" class="external-link">add</a></span><span class="op">(</span><span class="va">repo</span>, <span class="va">filename</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/commit.html">commit</a></span><span class="op">(</span><span class="va">repo</span>, <span class="st">"test"</span>, session <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">git_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"cd %s\ngit gc\ngit count-objects -v"</span>, <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">repo</span><span class="op">$</span><span class="va">path</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    intern <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">git_size</span> <span class="op">&lt;-</span> <span class="va">git_size</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"size-pack"</span>, <span class="va">git_size</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".*: (.*)"</span>, <span class="st">"\\1"</span>, <span class="va">git_size</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">repo_wt</span> <span class="op">&lt;-</span> <span class="fu">tmp_repo</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">repo_wts</span> <span class="op">&lt;-</span> <span class="fu">tmp_repo</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">repo_rds</span> <span class="op">&lt;-</span> <span class="fu">tmp_repo</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">repo_wvco</span> <span class="op">&lt;-</span> <span class="fu">tmp_repo</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">repo_wvcv</span> <span class="op">&lt;-</span> <span class="fu">tmp_repo</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">repo_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span></span>
<span>  <span class="fl">100</span>, <span class="op">{</span></span>
<span>    <span class="va">observed_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">airbag</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span></span>
<span>    <span class="va">this</span> <span class="op">&lt;-</span> <span class="va">airbag</span><span class="op">[</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">observed_subset</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">airbag</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">]</span></span>
<span>    <span class="va">this_sorted</span> <span class="op">&lt;-</span> <span class="va">airbag</span><span class="op">[</span><span class="va">observed_subset</span>, <span class="op">]</span></span>
<span>    <span class="va">fn_wt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/git2r/reference/workdir.html" class="external-link">workdir</a></span><span class="op">(</span><span class="va">repo_wt</span><span class="op">)</span>, <span class="st">"base_R.tsv"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="va">this</span>, <span class="va">fn_wt</span>, sep <span class="op">=</span> <span class="st">"\t"</span><span class="op">)</span></span>
<span>    <span class="va">fn_wts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/git2r/reference/workdir.html" class="external-link">workdir</a></span><span class="op">(</span><span class="va">repo_wts</span><span class="op">)</span>, <span class="st">"base_R.tsv"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="va">this_sorted</span>, <span class="va">fn_wts</span>, sep <span class="op">=</span> <span class="st">"\t"</span><span class="op">)</span></span>
<span>    <span class="va">fn_rds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/git2r/reference/workdir.html" class="external-link">workdir</a></span><span class="op">(</span><span class="va">repo_rds</span><span class="op">)</span>, <span class="st">"base_R.rds"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">this</span>, <span class="va">fn_rds</span><span class="op">)</span></span>
<span>    <span class="va">fn_wvco</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span><span class="va">this</span>, <span class="st">"airbag_optimize"</span>, <span class="va">repo_wvco</span>, sorting <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span></span>
<span>    <span class="va">fn_wvcv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span></span>
<span>      <span class="va">this</span>, <span class="st">"airbag_verbose"</span>, <span class="va">repo_wvcv</span>, sorting <span class="op">=</span> <span class="st">"X"</span>, optimize <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      write.table <span class="op">=</span> <span class="fu">commit_and_size</span><span class="op">(</span><span class="va">repo_wt</span>, <span class="va">fn_wt</span><span class="op">)</span>,</span>
<span>      write.table.sorted <span class="op">=</span> <span class="fu">commit_and_size</span><span class="op">(</span><span class="va">repo_wts</span>, <span class="va">fn_wts</span><span class="op">)</span>,</span>
<span>      saveRDS <span class="op">=</span> <span class="fu">commit_and_size</span><span class="op">(</span><span class="va">repo_rds</span>, <span class="va">fn_rds</span><span class="op">)</span>,</span>
<span>      write_vc.optimized <span class="op">=</span> <span class="fu">commit_and_size</span><span class="op">(</span><span class="va">repo_wvco</span>, <span class="va">fn_wvco</span><span class="op">)</span>,</span>
<span>      write_vc.verbose <span class="op">=</span> <span class="fu">commit_and_size</span><span class="op">(</span><span class="va">repo_wvcv</span>, <span class="va">fn_wvcv</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Each version of the data has on purpose a random order of
observations and variables. This is what would happen in a worst case
scenario as it would generate the largest possible diff. We also test
<code><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table()</a></code> with a stable ordering of the observations
and variables.</p>
<p>The randomised <code><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table()</a></code> yields the largest git
repository, converging to about 6.5 times the size of a git repository
based on the sorted <code><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table()</a></code>. <code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS()</a></code>
yields a 26% reduction in repository size compared to the randomised
<code><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table()</a></code>, but still is 4.8 times larger than the
sorted <code><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table()</a></code>. Note that the gain of storing binary
files in a git repository is much smaller than the gain in individual
file size because git compresses its history. The optimized
<code><a href="../reference/write_vc.html">write_vc()</a></code> starts at 88% and converges toward 78%, the
verbose version starts at 94% and converges towards 110%. Storage size
is a lot smaller when using <code><a href="../reference/write_vc.html">write_vc()</a></code> with optimization.
The verbose option of <code><a href="../reference/write_vc.html">write_vc()</a></code> has little the gain in
storage size. Another advantage is that <code><a href="../reference/write_vc.html">write_vc()</a></code> stores
metadata.</p>
<div class="figure">
<img src="efficiency_files/figure-html/plot_git_size-1.png" alt="Size of the git history using the different storage methods." width="576"><p class="caption">
Size of the git history using the different storage methods.
</p>
</div>
<div class="figure">
<img src="efficiency_files/figure-html/plot_rel_git_size-1.png" alt="Relative size of the git repository when compared to write.table()." width="576"><p class="caption">
Relative size of the git repository when compared to write.table().
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="timings">Timings<a class="anchor" aria-label="anchor" href="#timings"></a>
</h2>
<p>The code below runs a microbenchmark on the four methods. A
microbenchmark runs the code a hundred times and yields a distribution
of timings for each expression.</p>
<div class="section level3">
<h3 id="writing-data">Writing Data<a class="anchor" aria-label="anchor" href="#writing-data"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  write.table <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"base_R.tsv"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\t"</span><span class="op">)</span>,</span>
<span>  saveRDS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"base_R.rds"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  write_vc.optim <span class="op">=</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="st">"airbag_optimize"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span>,</span>
<span>  write_vc.verbose <span class="op">=</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="st">"airbag_verbose"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span>,</span>
<span>                              optimize <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mb</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">mb</span><span class="op">$</span><span class="va">time</span> <span class="op">/</span> <span class="fl">1e6</span></span></code></pre></div>
<p><code><a href="../reference/write_vc.html">write_vc()</a></code> takes 155% to 185% more time than
<code><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table()</a></code> because it needs to prepare the metadata and
sort the observations and variables. When overwriting existing data,
<code><a href="../reference/write_vc.html">write_vc()</a></code> checks the new data against the existing
metadata. <code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS()</a></code> requires 53% of the time that
<code><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table()</a></code> needs.</p>
<div class="figure">
<img src="efficiency_files/figure-html/plot_file_timings-1.png" alt="Boxplot of the write timings for the different methods." width="576"><p class="caption">
Boxplot of the write timings for the different methods.
</p>
</div>
</div>
<div class="section level3">
<h3 id="reading-data">Reading Data<a class="anchor" aria-label="anchor" href="#reading-data"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  read.table <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"base_R.tsv"</span><span class="op">)</span>, header <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          sep <span class="op">=</span> <span class="st">"\t"</span><span class="op">)</span>,</span>
<span>  readRDS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"base_R.rds"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  read_vc.optim <span class="op">=</span> <span class="fu"><a href="../reference/read_vc.html">read_vc</a></span><span class="op">(</span><span class="st">"airbag_optimize"</span>, <span class="va">root</span><span class="op">)</span>,</span>
<span>  read_vc.verbose <span class="op">=</span> <span class="fu"><a href="../reference/read_vc.html">read_vc</a></span><span class="op">(</span><span class="st">"airbag_verbose"</span>, <span class="va">root</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mb</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">mb</span><span class="op">$</span><span class="va">time</span> <span class="op">/</span> <span class="fl">1e6</span></span></code></pre></div>
<p>The timings on reading the data is another story. Reading the binary
format takes about 10% of the time needed to read the standard plain
text format using <code><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table()</a></code>. <code><a href="../reference/read_vc.html">read_vc()</a></code>
takes about 214% (optimized) and 257% (verbose) of the time needed by
<code><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table()</a></code>, which at first seems strange because
<code><a href="../reference/read_vc.html">read_vc()</a></code> calls <code><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table()</a></code> to read the files
and has some extra work to convert the variables to the correct data
type. The main difference is that <code><a href="../reference/read_vc.html">read_vc()</a></code> knows the
required data type <em>a priori</em> and passes this info to
<code><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table()</a></code>. Otherwise, <code><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table()</a></code> has to
guess the correct data type from the file.</p>
<div class="figure">
<img src="efficiency_files/figure-html/plot_read_timings-1.png" alt="Boxplots for the read timings for the different methods." width="576"><p class="caption">
Boxplots for the read timings for the different methods.
</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.muscardinus.be" class="external-link">Thierry Onkelinx</a>, <a href="https://www.vlaanderen.be/inbo/en-gb" class="external-link"><img src="https://ropensci.github.io/git2rdata/reference/figures/logo-en.png" height="24" alt="logo of the Research Institute for Nature and Forest (INBO)"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
